apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-pluto
  labels:
    app: pluto
    chart: {{ printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
data:
  application.yaml: |-
    pluto:
      domains:
        - https://{{ .Values.fairspace.ingress.domain }}
{{ toYaml .Values.pluto.externalDomains | indent 8 }}
      oauth2:
        base-url: {{ .Values.external.keycloak.baseUrl }}
        realm: {{ .Values.external.keycloak.realm }}
      storages:
{{ toYaml .Values.fairspace.storages | indent 8 }}

    server:
      error:
        whitelabel:
          enabled: false
      max-http-header-size: 65535

    security:
      oidc:
        redirect-after-logout-url: https://{{ .Values.fairspace.ingress.domain }}
        clientId: {{ .Values.external.keycloak.clientId }}
        clientSecret: {{ .Values.external.keycloak.clientSecret }}

    spring:
      zipkin:
        enabled: {{ .Values.tracing.enabled }}
        base-url: {{ .Values.tracing.baseUrl }}
      servlet:
        multipart:
          max-file-size: {{ .Values.pluto.maxFileSize }}
          max-request-size: {{ .Values.pluto.maxRequestSize }}

    zuul:
      retryable: false
      host:
        connect-timeout-millis: {{ .Values.pluto.connectTimeoutMillis }}
        socket-timeout-millis: {{ .Values.pluto.socketTimeoutMillis }}
      routes:
{{ if .Values.pluto.backends.storageRoutes }}
{{ toYaml .Values.pluto.backends.storageRoutes | indent 8 }}
{{ end }}
        saturn:
          path: /api/**
          url: {{ .Values.pluto.backends.saturn | default (printf "http://%s-saturn.%s.svc.cluster.local" .Release.Name .Release.Namespace)}}
          strip-prefix: false
      add-proxy-headers: false
